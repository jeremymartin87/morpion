stages:
  - lint
  - unitaires
  - integrations
  - sonar

phplint:
  stage: lint
  image: registry.gitlab.com/pipeline-components/php-linter:latest
  script:
    - parallel-lint --colors .

unit_tests:
  stage: unitaires
  image: php:8.3.7
  script:
    - apt-get update && apt-get install -y git unzip
    - pecl install pcov
    - docker-php-ext-enable pcov
    - echo "pcov.enabled=1" > /usr/local/etc/php/conf.d/pcov.ini
    - curl -sS https://getcomposer.org/installer | php
    - php composer.phar install
    - XDEBUG_MODE=coverage ./vendor/bin/phpunit --coverage-clover=coverage.xml
  artifacts:
    paths:
      - coverage.xml

integration_tests:
  stage: integrations
  image: composer:latest
  script:
    - composer require --dev phpunit/phpunit
    - chmod +x ./vendor/bin/phpunit
    - ./vendor/bin/phpunit Integration/GameFlowTest.php

sonarqube-check:
  stage: sonar
  image: 
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  allow_failure: true
  only:
    - master
  dependencies:
    - unit_tests
